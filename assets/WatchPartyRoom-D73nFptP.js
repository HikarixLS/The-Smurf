import{u as re,j as e}from"./index-KmnY2XZD.js";import{h as oe,e as le,b as a}from"./vendor-DTekaQTv.js";import{A as de,I as K,J as me,F as z,s as ue,E as pe,G as _e,K as ge,L as he}from"./index-D5LGCugf.js";import{H as ye}from"./Header-CNB_sl3P.js";import{w as i}from"./watchPartyService-CTa6eB4M.js";import{m as fe}from"./movieService-Cen5a6tX.js";import"./firebase-B8FQZRyY.js";import"./endpoints-CE5CwJAc.js";function g(t,r,o){if(!t?.contentWindow)return;const c="*";t.contentWindow.postMessage({type:"player",command:r,value:o},c),t.contentWindow.postMessage(JSON.stringify({event:r,data:o}),c),t.contentWindow.postMessage({action:r,value:o},c)}const h={PLAY:"play",PAUSE:"pause",SEEK:"seek",GET_TIME:"getTime"},ke=3,be=3e3,xe=8e3;function je(t,r){const o=Math.abs(t-r);return{needsSync:o>ke,drift:o}}function ve(t,r,o){if(!o||!r)return t;const c=(Date.now()-r)/1e3;return t+c}function Ne(t){let r=null;return{start(){this.stop(),r=setInterval(t,be)},stop(){r&&(clearInterval(r),r=null)}}}function Se(){let t=Date.now(),r=0,o=!1;return{reportProgress(c){Math.abs(c-r)>.1&&(t=Date.now(),r=c,o=!1)},check(){return Date.now()-t>xe&&(o=!0),o},reset(){t=Date.now(),r=0,o=!1}}}const Te="_room_1d2ka_1",Ee="_loadingPage_1d2ka_13",we="_spinner_1d2ka_35",Pe="_spin_1d2ka_35",Me="_layout_1d2ka_67",Re="_mainContent_1d2ka_79",Be="_topBar_1d2ka_95",Ce="_backBtn_1d2ka_113",Ie="_roomTitle_1d2ka_151",Le="_statusDot_1d2ka_179",Ae="_playing_1d2ka_193",We="_pulse_1d2ka_1",Fe="_paused_1d2ka_203",He="_waiting_1d2ka_211",Ue="_copyBtn_1d2ka_243",$e="_syncIndicator_1d2ka_283",De="_bufferWarning_1d2ka_307",Ve="_playerWrapper_1d2ka_327",Oe="_player_1d2ka_327",Ge="_noVideo_1d2ka_353",Ke="_controls_1d2ka_377",ze="_controlBtn_1d2ka_395",Ye="_syncLabel_1d2ka_433",Je="_memberCount_1d2ka_443",qe="_episodeSection_1d2ka_461",Qe="_episodeGrid_1d2ka_481",Xe="_episodeBtn_1d2ka_493",Ze="_epActive_1d2ka_535",es="_chatSidebar_1d2ka_549",ss="_chatHeader_1d2ka_567",ts="_membersList_1d2ka_595",ns="_memberTag_1d2ka_605",as="_hostTag_1d2ka_631",is="_chatMessages_1d2ka_645",cs="_chatEmpty_1d2ka_663",rs="_message_1d2ka_683",os="_myMessage_1d2ka_699",ls="_msgUser_1d2ka_711",ds="_msgText_1d2ka_723",ms="_msgTime_1d2ka_739",us="_chatInput_1d2ka_751",ps="_nicknameBar_1d2ka_855",_s="_nicknameDisplay_1d2ka_865",gs="_nicknameEditBtn_1d2ka_889",hs="_nicknameEdit_1d2ka_889",ys="_nicknameInput_1d2ka_937",fs="_nicknameSave_1d2ka_969",ks="_systemMessage_1d2ka_997",s={room:Te,loadingPage:Ee,spinner:we,spin:Pe,layout:Me,mainContent:Re,topBar:Be,backBtn:Ce,roomTitle:Ie,statusDot:Le,playing:Ae,pulse:We,paused:Fe,waiting:He,copyBtn:Ue,syncIndicator:$e,bufferWarning:De,playerWrapper:Ve,player:Oe,noVideo:Ge,controls:Ke,controlBtn:ze,syncLabel:Ye,memberCount:Je,episodeSection:qe,episodeGrid:Qe,episodeBtn:Xe,epActive:Ze,chatSidebar:es,chatHeader:ss,membersList:ts,memberTag:ns,hostTag:as,chatMessages:is,chatEmpty:cs,message:rs,myMessage:os,msgUser:ls,msgText:ds,msgTime:ms,chatInput:us,nicknameBar:ps,nicknameDisplay:_s,nicknameEditBtn:gs,nicknameEdit:hs,nicknameInput:ys,nicknameSave:fs,systemMessage:ks},Ps=()=>{const{roomId:t}=oe(),r=le(),{user:o}=re(),[c,Y]=a.useState(null),[v,J]=a.useState(null),[k,q]=a.useState([]),[b,P]=a.useState(""),[Q,X]=a.useState(!0),[Z,M]=a.useState(!1),[R,B]=a.useState(0),[ee,C]=a.useState(!1),[x,N]=a.useState(""),[I,y]=a.useState("waiting"),[L,se]=a.useState(0),p=a.useRef(null),A=a.useRef(null),f=a.useRef(!1),j=a.useRef(!1),W=a.useRef(0),S=a.useRef(null),F=a.useRef(Se()),T=a.useRef(null),H=a.useRef(null),_=i.getSession();a.useEffect(()=>{H.current=c},[c]),a.useEffect(()=>{o?.displayName?(N(o.displayName),i.updateName(o.displayName)):N(_.name)},[o]),a.useEffect(()=>{const n=o?.displayName||_.name;i.updateName(n),i.joinRoom(t).catch(console.error),i.sendMessage(t,`ðŸ“¢ ${n} Ä‘Ã£ vÃ o phÃ²ng`);const u=i.onRoomUpdate(t,l=>{if(!l){r("/watch-party");return}if(T.current&&l.members){const m=new Set(Object.keys(T.current));Object.keys(l.members).forEach(G=>{!m.has(G)&&_.id})}if(T.current=l.members||{},Y(l),l.playback?.episode!==void 0&&B(l.playback.episode),X(!1),!v&&l.movieSlug&&fe.getMovieDetail(l.movieSlug).then(m=>{m?.data?.item&&J(m.data.item)}).catch(()=>{}),l.hostId!==_.id&&l.playback&&!f.current){const m=ve(l.playback.currentTime||0,l.playback.updatedAt||Date.now(),l.playback.isPlaying),{needsSync:O}=je(W.current,m);O&&p.current?(f.current=!0,g(p.current,h.SEEK,m),setTimeout(()=>{f.current=!1},1e3),y("drifted")):y("synced"),p.current&&(l.playback.isPlaying?g(p.current,h.PLAY):g(p.current,h.PAUSE))}}),d=i.onMessages(t,q);return()=>{u(),d();const l=o?.displayName||_.name;i.sendMessage(t,`ðŸ‘‹ ${l} Ä‘Ã£ rá»i phÃ²ng`),i.leaveRoom(t)}},[t]),a.useEffect(()=>{const n=u=>{const d=u.data;if(!d||d.type!=="smurfSync")return;F.current.reportProgress(d.currentTime||0),se(d.currentTime||0),W.current=d.currentTime||0;const m=H.current?.hostId===_.id;switch(d.event){case"heartbeat":case"timeUpdate":m&&!f.current&&i.syncPlayback(t,{currentTime:d.currentTime,isPlaying:!d.paused}),d.buffering&&(y("buffering"),m&&(i.syncPlayback(t,{isPlaying:!1}),i.sendMessage(t,"â³ Äang Ä‘á»£i táº£i video...")));break;case"play":m&&!j.current&&(i.syncPlayback(t,{currentTime:d.currentTime,isPlaying:!0}),i.updateRoomStatus(t,"playing"));break;case"pause":m&&!j.current&&(i.syncPlayback(t,{currentTime:d.currentTime,isPlaying:!1}),i.updateRoomStatus(t,"paused"));break;case"seeked":m&&!f.current&&i.syncPlayback(t,{currentTime:d.currentTime});break;case"buffering":y("buffering");break}};return window.addEventListener("message",n),()=>window.removeEventListener("message",n)},[t]),a.useEffect(()=>(S.current=Ne(()=>{p.current&&g(p.current,h.GET_TIME),F.current.check()&&y("buffering")}),S.current.start(),()=>S.current?.stop()),[]),a.useEffect(()=>{A.current?.scrollIntoView({behavior:"smooth"})},[k]);const te=async n=>{n.preventDefault(),b.trim()&&(await i.sendMessage(t,b.trim()),P(""))},ne=a.useCallback(async()=>{if(c?.hostId!==_.id)return;j.current=!0;const n=c?.playback?.isPlaying;p.current&&(n?g(p.current,h.PAUSE):g(p.current,h.PLAY)),await i.syncPlayback(t,{isPlaying:!n,currentTime:L}),await i.updateRoomStatus(t,n?"paused":"playing"),await i.sendMessage(t,n?"â¸ï¸ Host Ä‘Ã£ táº¡m dá»«ng":"â–¶ï¸ Host Ä‘Ã£ báº¥m phÃ¡t"),setTimeout(()=>{j.current=!1},500)},[c,L,t]),ae=async n=>{c?.hostId===_.id&&(B(n),await i.syncPlayback(t,{episode:n,currentTime:0,isPlaying:!0}),await i.updateRoomStatus(t,"playing"),await i.sendMessage(t,`ðŸ“º ÄÃ£ chuyá»ƒn sang táº­p ${n+1}`))},ie=()=>{navigator.clipboard.writeText(window.location.href),M(!0),setTimeout(()=>M(!1),2e3)},ce=()=>r("/watch-party"),U=()=>{x.trim()&&(i.updateName(x.trim()),C(!1),c&&i.joinRoom(t))},$=c?.hostId===_.id,D=c?.members?Object.values(c.members):[],E=v?.episodes?.[0]?.server_data||[],V=E[R]?.link_embed||"",w={waiting:{icon:"â³",text:"Äang chá»",color:"#fbbf24"},synced:{icon:"âœ…",text:"Äá»“ng bá»™",color:"#22c55e"},drifted:{icon:"ðŸ”„",text:"Äang Ä‘á»“ng bá»™...",color:"#667eea"},buffering:{icon:"â³",text:"Äang táº£i...",color:"#ef4444"}}[I]||{};return Q?e.jsxs("div",{className:s.loadingPage,children:[e.jsx("div",{className:s.spinner}),e.jsx("p",{children:"Äang tham gia phÃ²ng..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{}),e.jsx("main",{className:s.room,children:e.jsxs("div",{className:s.layout,children:[e.jsxs("div",{className:s.mainContent,children:[e.jsxs("div",{className:s.topBar,children:[e.jsxs("button",{className:s.backBtn,onClick:ce,children:[e.jsx(de,{})," Rá»i phÃ²ng"]}),e.jsxs("div",{className:s.roomTitle,children:[e.jsx("span",{className:`${s.statusDot} ${s[c?.status||"waiting"]}`}),c?.movieOriginName||c?.movieName]}),e.jsxs("div",{className:s.syncIndicator,style:{color:w.color},children:[w.icon," ",w.text]}),e.jsx("button",{className:s.copyBtn,onClick:ie,children:Z?e.jsxs(e.Fragment,{children:[e.jsx(K,{})," ÄÃ£ copy"]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{})," Chia sáº»"]})})]}),e.jsx("div",{className:s.playerWrapper,children:V?e.jsx("iframe",{ref:p,src:V,className:s.player,allowFullScreen:!0,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"}):e.jsxs("div",{className:s.noVideo,children:[e.jsx(z,{size:48}),e.jsx("p",{children:v?"Äang táº£i video...":"Äang táº£i phim..."})]})}),e.jsxs("div",{className:s.controls,children:[e.jsxs("div",{className:s.controlLeft,children:[$?e.jsxs("button",{className:s.controlBtn,onClick:ne,children:[c?.playback?.isPlaying?e.jsx(ue,{}):e.jsx(z,{}),c?.playback?.isPlaying?" Táº¡m dá»«ng":" PhÃ¡t"]}):e.jsxs("span",{className:s.syncLabel,children:["ðŸ”„ Äá»“ng bá»™ vá»›i ",c?.hostName]}),I==="buffering"&&e.jsxs("span",{className:s.bufferWarning,children:[e.jsx(pe,{size:14})," Äang Ä‘á»£i táº£i video..."]})]}),e.jsx("div",{className:s.controlRight,children:e.jsxs("span",{className:s.memberCount,children:[e.jsx(_e,{})," ",D.length," ngÆ°á»i"]})})]}),E.length>1&&e.jsxs("div",{className:s.episodeSection,children:[e.jsx("h4",{children:"Táº­p phim"}),e.jsx("div",{className:s.episodeGrid,children:E.map((n,u)=>e.jsx("button",{className:`${s.episodeBtn} ${u===R?s.epActive:""}`,onClick:()=>ae(u),disabled:!$,children:n.name},u))})]})]}),e.jsxs("div",{className:s.chatSidebar,children:[e.jsxs("div",{className:s.chatHeader,children:[e.jsxs("h3",{children:["Chat (",k.length,")"]}),e.jsx("div",{className:s.membersList,children:D.map((n,u)=>e.jsx("span",{className:`${s.memberTag} ${n.isHost?s.hostTag:""}`,title:n.name,children:n.name.charAt(0)},u))})]}),e.jsx("div",{className:s.nicknameBar,children:ee?e.jsxs("div",{className:s.nicknameEdit,children:[e.jsx("input",{type:"text",value:x,onChange:n=>N(n.target.value),onKeyDown:n=>n.key==="Enter"&&U(),maxLength:20,autoFocus:!0,className:s.nicknameInput}),e.jsx("button",{onClick:U,className:s.nicknameSave,children:e.jsx(K,{size:14})})]}):e.jsxs("div",{className:s.nicknameDisplay,children:[e.jsxs("span",{children:["Báº¡n: ",e.jsx("strong",{children:x})]}),e.jsxs("button",{onClick:()=>C(!0),className:s.nicknameEditBtn,children:[e.jsx(ge,{size:12})," Äá»•i tÃªn"]})]})}),e.jsxs("div",{className:s.chatMessages,children:[k.length===0?e.jsx("div",{className:s.chatEmpty,children:e.jsx("p",{children:"ChÆ°a cÃ³ tin nháº¯n. HÃ£y báº¯t Ä‘áº§u trÃ² chuyá»‡n!"})}):k.map(n=>{const u=n.text.startsWith("ðŸ“¢")||n.text.startsWith("ðŸ‘‹")||n.text.startsWith("â–¶ï¸")||n.text.startsWith("â¸ï¸")||n.text.startsWith("ðŸ“º")||n.text.startsWith("â³");return e.jsxs("div",{className:`${s.message} ${n.userId===_.id?s.myMessage:""} ${u?s.systemMessage:""}`,children:[!u&&e.jsx("span",{className:s.msgUser,children:n.userName}),e.jsx("p",{className:s.msgText,children:n.text}),e.jsx("span",{className:s.msgTime,children:new Date(n.timestamp).toLocaleTimeString("vi",{hour:"2-digit",minute:"2-digit"})})]},n.id)}),e.jsx("div",{ref:A})]}),e.jsxs("form",{className:s.chatInput,onSubmit:te,children:[e.jsx("input",{type:"text",value:b,onChange:n=>P(n.target.value),placeholder:"Nháº­p tin nháº¯n...",maxLength:500}),e.jsx("button",{type:"submit",disabled:!b.trim(),children:e.jsx(he,{})})]})]})]})})]})};export{Ps as default};
