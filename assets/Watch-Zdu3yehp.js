import{j as e,u as re,L as oe}from"./index-Ce0K8VUX.js";import{b as o,h as ie,e as ae}from"./vendor-DTekaQTv.js";import{F as I,r as ce,s as le,t as ue,u as de,v as me,w as pe,x as _e,y as ge,z as he,A as ve,B as fe,h as je,i as xe}from"./index-D5LGCugf.js";import{H as D}from"./Header-aWFzr601.js";import{F as ye}from"./helpers-CsWJ-lTd.js";import{H as w}from"./hls-Cp2x8l1r.js";import{M as ke}from"./MovieRow-DFzDVBx_.js";import{m as W}from"./movieService-BaVLUEmp.js";import{e as Se}from"./watchlistService-D4l9ybEk.js";import"./firebase-B8FQZRyY.js";import"./MovieCard-DZwTorOR.js";import"./index-BDRdhlOT.js";import"./endpoints-xqRzFTK4.js";const Ne="_playerContainer_ekrng_1",Te="_fullscreen_ekrng_23",be="_video_ekrng_31",Ce="_centerPlay_ekrng_47",Be="_skipIntro_ekrng_101",we="_controls_ekrng_167",Le="_controlsVisible_ekrng_191",Pe="_progressBar_ekrng_201",Me="_progressBuffered_ekrng_231",Ee="_progressPlayed_ekrng_251",Fe="_progressThumb_ekrng_271",Re="_controlsRow_ekrng_309",$e="_controlsLeft_ekrng_321",Ae="_controlsRight_ekrng_323",qe="_controlBtn_ekrng_337",Ve="_seekLabel_ekrng_375",ze="_volumeControl_ekrng_395",Ie="_volumeSlider_ekrng_407",De="_timeDisplay_ekrng_437",We="_settingsWrapper_ekrng_455",Oe="_settingsMenu_ekrng_463",He="_settingsTitle_ekrng_493",Qe="_qualityOption_ekrng_515",Ge="_qualityActive_ekrng_549",s={playerContainer:Ne,fullscreen:Te,video:be,centerPlay:Ce,skipIntro:Be,controls:we,controlsVisible:Le,progressBar:Pe,progressBuffered:Me,progressPlayed:Ee,progressThumb:Fe,controlsRow:Re,controlsLeft:$e,controlsRight:Ae,controlBtn:qe,seekLabel:Ve,volumeControl:ze,volumeSlider:Ie,timeDisplay:De,settingsWrapper:We,settingsMenu:Oe,settingsTitle:He,qualityOption:Qe,qualityActive:Ge},Ke=({src:m,poster:T,onError:h})=>{const n=o.useRef(null),v=o.useRef(null),b=o.useRef(null),f=o.useRef(null),[p,k]=o.useState(!1),[S,L]=o.useState(0),[u,P]=o.useState(0),[j,M]=o.useState(1),[N,x]=o.useState(!1),[g,_]=o.useState(!1),[c,a]=o.useState(!0),[C,R]=o.useState(!1),[O,H]=o.useState([]),[$,Q]=o.useState(-1),[G,K]=o.useState(0),[U,A]=o.useState(!1);o.useEffect(()=>{const t=n.current;if(!(!t||!m))if(w.isSupported()){const i=new w({maxBufferLength:30,maxMaxBufferLength:60});return v.current=i,i.loadSource(m),i.attachMedia(t),i.on(w.Events.MANIFEST_PARSED,(d,l)=>{const B=l.levels.map((y,ne)=>({index:ne,height:y.height,width:y.width,bitrate:y.bitrate,label:y.height?`${y.height}p`:`${Math.round(y.bitrate/1e3)}kbps`}));H(B),t.play().catch(()=>{})}),i.on(w.Events.ERROR,(d,l)=>{l.fatal&&h&&h(l)}),()=>{i.destroy(),v.current=null}}else t.canPlayType("application/vnd.apple.mpegurl")&&(t.src=m,t.addEventListener("loadedmetadata",()=>{t.play().catch(()=>{})}))},[m]),o.useEffect(()=>{const t=n.current;if(!t)return;const i=()=>{L(t.currentTime),A(t.currentTime<120&&t.currentTime>5),t.buffered.length>0&&K(t.buffered.end(t.buffered.length-1))},d=()=>P(t.duration||0),l=()=>k(!0),B=()=>k(!1);return t.addEventListener("timeupdate",i),t.addEventListener("durationchange",d),t.addEventListener("play",l),t.addEventListener("pause",B),()=>{t.removeEventListener("timeupdate",i),t.removeEventListener("durationchange",d),t.removeEventListener("play",l),t.removeEventListener("pause",B)}},[]);const E=o.useCallback(()=>{a(!0),clearTimeout(f.current),p&&(f.current=setTimeout(()=>a(!1),3e3))},[p]);o.useEffect(()=>(E(),()=>clearTimeout(f.current)),[p,E]),o.useEffect(()=>{const t=()=>{_(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",t),()=>document.removeEventListener("fullscreenchange",t)},[]);const F=()=>{const t=n.current;t&&(t.paused?t.play():t.pause())},q=t=>{const i=n.current;i&&(i.currentTime=Math.max(0,Math.min(i.duration,i.currentTime+t)))},X=()=>{const t=n.current;t&&(t.currentTime=Math.min(t.duration,t.currentTime+90),A(!1))},J=t=>{const i=n.current;if(!i||!u)return;const d=t.currentTarget.getBoundingClientRect(),l=(t.clientX-d.left)/d.width;i.currentTime=l*u},Y=t=>{const i=parseFloat(t.target.value);M(i),x(i===0),n.current&&(n.current.volume=i,n.current.muted=i===0)},Z=()=>{const t=n.current;if(!t)return;const i=!N;x(i),t.muted=i},ee=()=>{const t=b.current;t&&(document.fullscreenElement?document.exitFullscreen():t.requestFullscreen())},V=t=>{v.current&&(v.current.currentLevel=t,Q(t)),R(!1)},z=t=>{if(!t||isNaN(t))return"00:00";const i=Math.floor(t/3600),d=Math.floor(t%3600/60),l=Math.floor(t%60);return i>0?`${i}:${String(d).padStart(2,"0")}:${String(l).padStart(2,"0")}`:`${String(d).padStart(2,"0")}:${String(l).padStart(2,"0")}`},te=u?S/u*100:0,se=u?G/u*100:0;return e.jsxs("div",{ref:b,className:`${s.playerContainer} ${g?s.fullscreen:""}`,onMouseMove:E,onMouseLeave:()=>p&&a(!1),onClick:t=>{(t.target===n.current||t.target.classList.contains(s.videoOverlay))&&F()},children:[e.jsx("video",{ref:n,className:s.video,poster:T,playsInline:!0}),!p&&e.jsx("div",{className:s.centerPlay,onClick:F,children:e.jsx(I,{size:48})}),U&&c&&e.jsxs("button",{className:s.skipIntro,onClick:X,children:[e.jsx(ce,{})," Skip Intro"]}),e.jsxs("div",{className:`${s.controls} ${c?s.controlsVisible:""}`,children:[e.jsxs("div",{className:s.progressBar,onClick:J,children:[e.jsx("div",{className:s.progressBuffered,style:{width:`${se}%`}}),e.jsx("div",{className:s.progressPlayed,style:{width:`${te}%`},children:e.jsx("div",{className:s.progressThumb})})]}),e.jsxs("div",{className:s.controlsRow,children:[e.jsxs("div",{className:s.controlsLeft,children:[e.jsx("button",{className:s.controlBtn,onClick:F,children:p?e.jsx(le,{size:20}):e.jsx(I,{size:20})}),e.jsxs("button",{className:s.controlBtn,onClick:()=>q(-10),title:"Rewind 10s",children:[e.jsx(ue,{size:18}),e.jsx("span",{className:s.seekLabel,children:"10"})]}),e.jsxs("button",{className:s.controlBtn,onClick:()=>q(10),title:"Forward 10s",children:[e.jsx(de,{size:18}),e.jsx("span",{className:s.seekLabel,children:"10"})]}),e.jsxs("div",{className:s.volumeControl,children:[e.jsx("button",{className:s.controlBtn,onClick:Z,children:N||j===0?e.jsx(me,{size:18}):e.jsx(pe,{size:18})}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.05",value:N?0:j,onChange:Y,className:s.volumeSlider})]}),e.jsxs("span",{className:s.timeDisplay,children:[z(S)," / ",z(u)]})]}),e.jsxs("div",{className:s.controlsRight,children:[e.jsxs("div",{className:s.settingsWrapper,children:[e.jsx("button",{className:s.controlBtn,onClick:()=>R(!C),children:e.jsx(_e,{size:18})}),C&&e.jsxs("div",{className:s.settingsMenu,children:[e.jsx("div",{className:s.settingsTitle,children:"Chất lượng"}),e.jsx("button",{className:`${s.qualityOption} ${$===-1?s.qualityActive:""}`,onClick:()=>V(-1),children:"Auto"}),O.map(t=>e.jsx("button",{className:`${s.qualityOption} ${$===t.index?s.qualityActive:""}`,onClick:()=>V(t.index),children:t.label},t.index))]})]}),e.jsx("button",{className:s.controlBtn,onClick:ee,children:g?e.jsx(ge,{size:18}):e.jsx(he,{size:18})})]})]})]})]})},Ue="_watch_e39pj_1",Xe="_loadingPage_e39pj_7",Je="_errorPage_e39pj_15",Ye="_container_e39pj_34",Ze="_topBar_e39pj_41",et="_backBtn_e39pj_48",tt="_nowPlaying_e39pj_68",st="_movieName_e39pj_75",nt="_episodeName_e39pj_84",rt="_playerSection_e39pj_91",ot="_playerWrapper_e39pj_95",it="_player_e39pj_91",at="_noVideo_e39pj_113",ct="_serverSection_e39pj_126",lt="_sectionTitle_e39pj_130",ut="_serverList_e39pj_137",dt="_serverBtn_e39pj_144",mt="_serverActive_e39pj_160",pt="_episodeSection_e39pj_167",_t="_episodeToggle_e39pj_171",gt="_episodeGrid_e39pj_184",ht="_episodeBtn_e39pj_191",vt="_episodeActive_e39pj_208",ft="_movieInfo_e39pj_216",jt="_movieTitle_e39pj_221",xt="_meta_e39pj_228",yt="_qualityTag_e39pj_237",kt="_langTag_e39pj_246",St="_relatedSection_e39pj_256",r={watch:Ue,loadingPage:Xe,errorPage:Je,container:Ye,topBar:Ze,backBtn:et,nowPlaying:tt,movieName:st,episodeName:nt,playerSection:rt,playerWrapper:ot,player:it,noVideo:at,serverSection:ct,sectionTitle:lt,serverList:ut,serverBtn:dt,serverActive:mt,episodeSection:pt,episodeToggle:_t,episodeGrid:gt,episodeBtn:ht,episodeActive:vt,movieInfo:ft,movieTitle:jt,meta:xt,qualityTag:yt,langTag:kt,relatedSection:St},At=()=>{const{slug:m}=ie(),T=ae(),{user:h}=re(),[n,v]=o.useState(null),[b,f]=o.useState(!0),[p,k]=o.useState(0),[S,L]=o.useState(0),[u,P]=o.useState([]),[j,M]=o.useState(!0);o.useEffect(()=>{N()},[m]),o.useEffect(()=>{h&&n&&Se(h.uid,n).catch(()=>{})},[h,n]);const N=async()=>{f(!0);try{const c=await W.getMovieDetail(m);if(c?.data?.item&&(v(c.data.item),c.data.item.category?.length>0))try{const a=await W.getMoviesByCategory(c.data.item.category[0].slug,1);a?.data?.items&&P(a.data.items.filter(C=>C.slug!==m).slice(0,12))}catch{}}catch(c){console.error("Error:",c)}finally{f(!1)}};if(b)return e.jsx("div",{className:r.loadingPage,children:e.jsx(oe,{})});if(!n)return e.jsxs(e.Fragment,{children:[e.jsx(D,{}),e.jsxs("div",{className:r.errorPage,children:[e.jsx("h1",{children:"Không tìm thấy phim"}),e.jsx("button",{onClick:()=>T("/"),children:"Về trang chủ"})]})]});const x=n.episodes||[],g=x[S]?.server_data||[],_=g[p];return e.jsxs(e.Fragment,{children:[e.jsx(D,{}),e.jsxs("main",{className:r.watch,children:[e.jsxs("div",{className:r.container,children:[e.jsxs("div",{className:r.topBar,children:[e.jsxs("button",{className:r.backBtn,onClick:()=>T(`/movie/${m}`),children:[e.jsx(ve,{})," Quay lại"]}),e.jsxs("div",{className:r.nowPlaying,children:[e.jsx("span",{className:r.movieName,children:n.origin_name||n.name}),_&&e.jsxs("span",{className:r.episodeName,children:["- Tập ",_.name]})]})]}),e.jsx("div",{className:r.playerSection,children:e.jsx("div",{className:r.playerWrapper,children:_?.link_m3u8?e.jsx(Ke,{src:_.link_m3u8,poster:n.poster_url||n.thumb_url}):_?.link_embed?e.jsx("iframe",{src:_.link_embed,className:r.player,allowFullScreen:!0,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"}):e.jsxs("div",{className:r.noVideo,children:[e.jsx(fe,{size:48}),e.jsx("p",{children:"Không có nguồn phim khả dụng"})]})})}),x.length>1&&e.jsxs("div",{className:r.serverSection,children:[e.jsx("h3",{className:r.sectionTitle,children:"Chọn server"}),e.jsx("div",{className:r.serverList,children:x.map((c,a)=>e.jsx("button",{className:`${r.serverBtn} ${a===S?r.serverActive:""}`,onClick:()=>{L(a),k(0)},children:c.server_name},a))})]}),g.length>1&&e.jsxs("div",{className:r.episodeSection,children:[e.jsxs("button",{className:r.episodeToggle,onClick:()=>M(!j),children:[e.jsxs("h3",{className:r.sectionTitle,children:["Danh sách tập (",g.length," tập)"]}),j?e.jsx(je,{}):e.jsx(xe,{})]}),j&&e.jsx("div",{className:r.episodeGrid,children:g.map((c,a)=>e.jsx("button",{className:`${r.episodeBtn} ${a===p?r.episodeActive:""}`,onClick:()=>k(a),children:c.name},a))})]}),e.jsxs("div",{className:r.movieInfo,children:[e.jsx("h2",{className:r.movieTitle,children:n.origin_name||n.name}),e.jsxs("div",{className:r.meta,children:[n.year&&e.jsx("span",{children:n.year}),n.quality&&e.jsx("span",{className:r.qualityTag,children:n.quality}),n.lang&&e.jsx("span",{className:r.langTag,children:n.lang}),n.episode_current&&e.jsx("span",{children:n.episode_current})]})]})]}),u.length>0&&e.jsx("div",{className:r.relatedSection,children:e.jsx(ke,{title:"Phim đề xuất",movies:u})})]}),e.jsx(ye,{})]})};export{At as default};
