import{D as u,G as r,H as b,I as p,J as R,K as l,M as h,N as g,O as $,P as w,Q as y}from"./firebase-B8FQZRyY.js";import{d as a,i as v}from"./index-DvuVciiU.js";const m="watchPartyRooms",d="watchPartyMessages",S=()=>{const e=["Vui","Hào","Dũng","Xinh","Cool","Hot","Cute"],t=["Smurf","Gấu","Mèo","Cáo","Thỏ","Rồng","Hổ"],o=e[Math.floor(Math.random()*e.length)],s=t[Math.floor(Math.random()*t.length)];return`${o}${s}${Math.floor(Math.random()*100)}`},c=()=>{let e=localStorage.getItem("smurf_wp_session");if(e)return JSON.parse(e);const t={id:`user_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,name:S(),createdAt:Date.now()};return localStorage.setItem("smurf_wp_session",JSON.stringify(t)),t},D={isAvailable:()=>v()&&a!==null,getSession:c,updateName:e=>{const t=c();return t.name=e,localStorage.setItem("smurf_wp_session",JSON.stringify(t)),t},createRoom:async({movieSlug:e,movieName:t,movieThumb:o})=>{if(!a)throw new Error("Firebase chưa được cấu hình");const s=c(),n=g(r(a,m)),i={id:n.key,movieSlug:e,movieName:t,movieThumb:o||"",hostId:s.id,hostName:s.name,status:"waiting",createdAt:Date.now(),playback:{currentTime:0,isPlaying:!1,episode:0,server:0,updatedAt:Date.now()},members:{[s.id]:{name:s.name,joinedAt:Date.now(),isHost:!0}},viewerCount:1};return await $(n,i),i},joinRoom:async e=>{if(!a)throw new Error("Firebase chưa được cấu hình");const t=c(),o=r(a,`${m}/${e}/members/${t.id}`);await $(o,{name:t.name,joinedAt:Date.now(),isHost:!1});const s=r(a,`${m}/${e}`),n=await y(s);if(n.exists()){const i=n.val(),f=i.members?Object.keys(i.members).length:1;await w(s,{viewerCount:f+1})}return t},leaveRoom:async e=>{if(!a)return;const t=c(),o=r(a,`${m}/${e}/members/${t.id}`);await u(o);const s=r(a,`${m}/${e}`),n=await y(s);if(n.exists()){const i=n.val(),f=i.members?Object.keys(i.members).length:0;await w(s,{viewerCount:Math.max(0,f)}),f===0&&(await u(s),await u(r(a,`${d}/${e}`)))}},getRooms:async()=>{if(!a)return[];const e=r(a,m),t=await y(e);if(!t.exists())return[];const o=[];return t.forEach(s=>{o.push({...s.val(),id:s.key})}),o.sort((s,n)=>n.createdAt-s.createdAt)},onRoomsUpdate:e=>{if(!a)return()=>{};const t=r(a,m);return l(t,o=>{const s=[];o.exists()&&o.forEach(n=>{s.push({...n.val(),id:n.key})}),e(s.sort((n,i)=>i.createdAt-n.createdAt))}),()=>h(t)},onRoomUpdate:(e,t)=>{if(!a)return()=>{};const o=r(a,`${m}/${e}`);return l(o,s=>{t(s.exists()?s.val():null)}),()=>h(o)},syncPlayback:async(e,t)=>{if(!a)return;const o=r(a,`${m}/${e}/playback`);await w(o,{...t,updatedAt:Date.now()})},updateRoomStatus:async(e,t)=>{a&&await w(r(a,`${m}/${e}`),{status:t})},sendMessage:async(e,t)=>{if(!a)return;const o=c(),s=g(r(a,`${d}/${e}`));await $(s,{userId:o.id,userName:o.name,text:t,timestamp:Date.now()})},onMessages:(e,t)=>{if(!a)return()=>{};const o=b(r(a,`${d}/${e}`),R("timestamp"),p(100));return l(o,s=>{const n=[];s.exists()&&s.forEach(i=>{n.push({...i.val(),id:i.key})}),t(n)}),()=>h(o)},deleteRoom:async e=>{a&&(await u(r(a,`${m}/${e}`)),await u(r(a,`${d}/${e}`)))}};export{D as w};
