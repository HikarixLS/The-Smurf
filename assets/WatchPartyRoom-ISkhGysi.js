import{u as J,j as e}from"./index-TLiYB9Yu.js";import{h as q,e as Q,b as i}from"./vendor-DTekaQTv.js";import{A as X,I as P,J as Y,F as R,s as Z,G as ee,K as se,L as te}from"./index-D5LGCugf.js";import{H as ae}from"./Header-CLmer38b.js";import{w as a}from"./watchPartyService-D57Zfx3K.js";import{m as ne}from"./movieService-B3xwX3iv.js";import"./firebase-B8FQZRyY.js";import"./endpoints-D8T1TGp9.js";const ce="_room_1kjcc_1",ie="_loadingPage_1kjcc_13",oe="_spinner_1kjcc_35",re="_spin_1kjcc_35",me="_layout_1kjcc_67",le="_mainContent_1kjcc_79",de="_topBar_1kjcc_95",pe="_backBtn_1kjcc_113",_e="_roomTitle_1kjcc_151",he="_statusDot_1kjcc_179",ue="_playing_1kjcc_193",je="_pulse_1kjcc_1",ge="_paused_1kjcc_203",ke="_waiting_1kjcc_211",ye="_copyBtn_1kjcc_243",xe="_playerWrapper_1kjcc_285",be="_player_1kjcc_285",ve="_noVideo_1kjcc_311",Ne="_controls_1kjcc_335",fe="_controlBtn_1kjcc_353",Se="_syncLabel_1kjcc_391",we="_memberCount_1kjcc_401",Be="_episodeSection_1kjcc_419",Me="_episodeGrid_1kjcc_439",Te="_episodeBtn_1kjcc_451",Ce="_epActive_1kjcc_493",Ee="_chatSidebar_1kjcc_507",Pe="_chatHeader_1kjcc_525",Re="_membersList_1kjcc_553",Le="_memberTag_1kjcc_563",Fe="_hostTag_1kjcc_589",Ie="_chatMessages_1kjcc_603",$e="_chatEmpty_1kjcc_621",He="_message_1kjcc_641",We="_myMessage_1kjcc_657",Ae="_msgUser_1kjcc_669",Ue="_msgText_1kjcc_681",Ve="_msgTime_1kjcc_697",Ge="_chatInput_1kjcc_709",Ke="_nicknameBar_1kjcc_813",Oe="_nicknameDisplay_1kjcc_823",ze="_nicknameEditBtn_1kjcc_847",De="_nicknameEdit_1kjcc_847",Je="_nicknameInput_1kjcc_895",qe="_nicknameSave_1kjcc_927",Qe="_systemMessage_1kjcc_955",s={room:ce,loadingPage:ie,spinner:oe,spin:re,layout:me,mainContent:le,topBar:de,backBtn:pe,roomTitle:_e,statusDot:he,playing:ue,pulse:je,paused:ge,waiting:ke,copyBtn:ye,playerWrapper:xe,player:be,noVideo:ve,controls:Ne,controlBtn:fe,syncLabel:Se,memberCount:we,episodeSection:Be,episodeGrid:Me,episodeBtn:Te,epActive:Ce,chatSidebar:Ee,chatHeader:Pe,membersList:Re,memberTag:Le,hostTag:Fe,chatMessages:Ie,chatEmpty:$e,message:He,myMessage:We,msgUser:Ae,msgText:Ue,msgTime:Ve,chatInput:Ge,nicknameBar:Ke,nicknameDisplay:Oe,nicknameEditBtn:ze,nicknameEdit:De,nicknameInput:Je,nicknameSave:qe,systemMessage:Qe},is=()=>{const{roomId:c}=q(),v=Q(),{user:l}=J(),[o,L]=i.useState(null),[j,F]=i.useState(null),[d,I]=i.useState([]),[p,N]=i.useState(""),[$,H]=i.useState(!0),[W,f]=i.useState(!1),[S,w]=i.useState(0),[A,B]=i.useState(!1),[_,g]=i.useState(""),M=i.useRef(null),U=i.useRef(null),k=i.useRef(null),m=a.getSession();i.useEffect(()=>{l?.displayName?(g(l.displayName),a.updateName(l.displayName)):g(m.name)},[l]),i.useEffect(()=>{const t=l?.displayName||m.name;a.updateName(t),a.joinRoom(c).catch(n=>{console.error("Join error:",n)}),a.sendMessage(c,`ðŸ“¢ ${t} Ä‘Ã£ vÃ o phÃ²ng`);const r=a.onRoomUpdate(c,n=>{if(!n){v("/watch-party");return}if(k.current&&n.members){const u=Object.keys(k.current);Object.keys(n.members).forEach(b=>{!u.includes(b)&&b!==m.id&&n.members[b]})}k.current=n.members||{},L(n),n.playback?.episode!==void 0&&w(n.playback.episode),H(!1),!j&&n.movieSlug&&ne.getMovieDetail(n.movieSlug).then(u=>{u?.data?.item&&F(u.data.item)}).catch(()=>{})}),D=a.onMessages(c,n=>{I(n)});return()=>{r(),D();const n=l?.displayName||m.name;a.sendMessage(c,`ðŸ‘‹ ${n} Ä‘Ã£ rá»i phÃ²ng`),a.leaveRoom(c)}},[c]),i.useEffect(()=>{M.current?.scrollIntoView({behavior:"smooth"})},[d]);const V=async t=>{t.preventDefault(),p.trim()&&(await a.sendMessage(c,p.trim()),N(""))},G=async()=>{if(o?.hostId!==m.id)return;const t=o?.playback?.isPlaying;await a.syncPlayback(c,{isPlaying:!t}),await a.updateRoomStatus(c,t?"paused":"playing"),await a.sendMessage(c,t?"â¸ï¸ Host Ä‘Ã£ táº¡m dá»«ng":"â–¶ï¸ Host Ä‘Ã£ báº¥m phÃ¡t")},K=async t=>{o?.hostId===m.id&&(w(t),await a.syncPlayback(c,{episode:t,currentTime:0,isPlaying:!0}),await a.updateRoomStatus(c,"playing"),await a.sendMessage(c,`ðŸ“º ÄÃ£ chuyá»ƒn sang táº­p ${t+1}`))},O=()=>{navigator.clipboard.writeText(window.location.href),f(!0),setTimeout(()=>f(!1),2e3)},z=async()=>{v("/watch-party")},T=()=>{_.trim()&&(a.updateName(_.trim()),B(!1),o&&a.joinRoom(c))},y=o?.hostId===m.id,C=o?.members?Object.values(o.members):[],x=j?.episodes?.[0]?.server_data||[],h=x[S],E=h?.link_m3u8||h?.link_embed||"";return!h?.link_m3u8&&h?.link_embed,$?e.jsxs("div",{className:s.loadingPage,children:[e.jsx("div",{className:s.spinner}),e.jsx("p",{children:"Äang tham gia phÃ²ng..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{}),e.jsx("main",{className:s.room,children:e.jsxs("div",{className:s.layout,children:[e.jsxs("div",{className:s.mainContent,children:[e.jsxs("div",{className:s.topBar,children:[e.jsxs("button",{className:s.backBtn,onClick:z,children:[e.jsx(X,{})," Rá»i phÃ²ng"]}),e.jsxs("div",{className:s.roomTitle,children:[e.jsx("span",{className:`${s.statusDot} ${s[o?.status||"waiting"]}`}),o?.movieOriginName||o?.movieName]}),e.jsx("button",{className:s.copyBtn,onClick:O,children:W?e.jsxs(e.Fragment,{children:[e.jsx(P,{})," ÄÃ£ copy"]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{})," Chia sáº» link"]})})]}),e.jsx("div",{className:s.playerWrapper,children:E?e.jsx("iframe",{ref:U,src:E,className:s.player,allowFullScreen:!0,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"}):e.jsxs("div",{className:s.noVideo,children:[e.jsx(R,{size:48}),e.jsx("p",{children:j?"Äang táº£i video...":"Äang táº£i phim..."})]})}),e.jsxs("div",{className:s.controls,children:[e.jsxs("div",{className:s.controlLeft,children:[y&&e.jsxs("button",{className:s.controlBtn,onClick:G,children:[o?.playback?.isPlaying?e.jsx(Z,{}):e.jsx(R,{}),o?.playback?.isPlaying?"Táº¡m dá»«ng":"PhÃ¡t"]}),!y&&e.jsxs("span",{className:s.syncLabel,children:["ðŸ”„ Äá»“ng bá»™ vá»›i ",o?.hostName]})]}),e.jsx("div",{className:s.controlRight,children:e.jsxs("span",{className:s.memberCount,children:[e.jsx(ee,{})," ",C.length," ngÆ°á»i"]})})]}),x.length>1&&e.jsxs("div",{className:s.episodeSection,children:[e.jsx("h4",{children:"Táº­p phim"}),e.jsx("div",{className:s.episodeGrid,children:x.map((t,r)=>e.jsx("button",{className:`${s.episodeBtn} ${r===S?s.epActive:""}`,onClick:()=>K(r),disabled:!y,children:t.name},r))})]})]}),e.jsxs("div",{className:s.chatSidebar,children:[e.jsxs("div",{className:s.chatHeader,children:[e.jsxs("h3",{children:["Chat (",d.length,")"]}),e.jsx("div",{className:s.membersList,children:C.map((t,r)=>e.jsx("span",{className:`${s.memberTag} ${t.isHost?s.hostTag:""}`,title:t.name,children:t.name.charAt(0)},r))})]}),e.jsx("div",{className:s.nicknameBar,children:A?e.jsxs("div",{className:s.nicknameEdit,children:[e.jsx("input",{type:"text",value:_,onChange:t=>g(t.target.value),onKeyDown:t=>t.key==="Enter"&&T(),maxLength:20,autoFocus:!0,className:s.nicknameInput}),e.jsx("button",{onClick:T,className:s.nicknameSave,children:e.jsx(P,{size:14})})]}):e.jsxs("div",{className:s.nicknameDisplay,children:[e.jsxs("span",{children:["Báº¡n: ",e.jsx("strong",{children:_})]}),e.jsxs("button",{onClick:()=>B(!0),className:s.nicknameEditBtn,children:[e.jsx(se,{size:12})," Äá»•i tÃªn"]})]})}),e.jsxs("div",{className:s.chatMessages,children:[d.length===0?e.jsx("div",{className:s.chatEmpty,children:e.jsx("p",{children:"ChÆ°a cÃ³ tin nháº¯n. HÃ£y báº¯t Ä‘áº§u trÃ² chuyá»‡n!"})}):d.map(t=>{const r=t.text.startsWith("ðŸ“¢")||t.text.startsWith("ðŸ‘‹")||t.text.startsWith("â–¶ï¸")||t.text.startsWith("â¸ï¸")||t.text.startsWith("ðŸ“º");return e.jsxs("div",{className:`${s.message} ${t.userId===m.id?s.myMessage:""} ${r?s.systemMessage:""}`,children:[!r&&e.jsx("span",{className:s.msgUser,children:t.userName}),e.jsx("p",{className:s.msgText,children:t.text}),e.jsx("span",{className:s.msgTime,children:new Date(t.timestamp).toLocaleTimeString("vi",{hour:"2-digit",minute:"2-digit"})})]},t.id)}),e.jsx("div",{ref:M})]}),e.jsxs("form",{className:s.chatInput,onSubmit:V,children:[e.jsx("input",{type:"text",value:p,onChange:t=>N(t.target.value),placeholder:"Nháº­p tin nháº¯n...",maxLength:500}),e.jsx("button",{type:"submit",disabled:!p.trim(),children:e.jsx(te,{})})]})]})]})})]})};export{is as default};
