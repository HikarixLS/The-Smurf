import{j as e}from"./index-CKIGZ-Zr.js";import{h as I,e as H,b as c}from"./vendor-DTekaQTv.js";import{A as $,I as A,J as U,F as f,s as V,G,K as W}from"./index-CWt2mSl_.js";import{H as D}from"./Header-CVFfGWSw.js";import{w as i}from"./watchPartyService-D8JSnK3U.js";import{m as J}from"./movieService-BgO2l0O7.js";import"./firebase-B8FQZRyY.js";import"./endpoints-DUQzCDa2.js";const z="_room_8hwpm_1",K="_loadingPage_8hwpm_13",O="_spinner_8hwpm_35",q="_spin_8hwpm_35",Q="_layout_8hwpm_67",X="_mainContent_8hwpm_79",Y="_topBar_8hwpm_95",Z="_backBtn_8hwpm_113",ee="_roomTitle_8hwpm_151",se="_statusDot_8hwpm_179",te="_playing_8hwpm_193",ae="_pulse_8hwpm_1",ne="_paused_8hwpm_203",ie="_waiting_8hwpm_211",oe="_copyBtn_8hwpm_243",ce="_playerWrapper_8hwpm_285",re="_player_8hwpm_285",me="_noVideo_8hwpm_311",le="_controls_8hwpm_335",pe="_controlBtn_8hwpm_353",de="_syncLabel_8hwpm_391",he="_memberCount_8hwpm_401",_e="_episodeSection_8hwpm_419",ge="_episodeGrid_8hwpm_439",ue="_episodeBtn_8hwpm_451",ye="_epActive_8hwpm_493",we="_chatSidebar_8hwpm_507",xe="_chatHeader_8hwpm_525",je="_membersList_8hwpm_553",be="_memberTag_8hwpm_563",ve="_hostTag_8hwpm_589",Ne="_chatMessages_8hwpm_603",fe="_chatEmpty_8hwpm_621",Se="_message_8hwpm_641",Te="_myMessage_8hwpm_657",Ce="_msgUser_8hwpm_669",ke="_msgText_8hwpm_681",Be="_msgTime_8hwpm_697",Pe="_chatInput_8hwpm_709",s={room:z,loadingPage:K,spinner:O,spin:q,layout:Q,mainContent:X,topBar:Y,backBtn:Z,roomTitle:ee,statusDot:se,playing:te,pulse:ae,paused:ne,waiting:ie,copyBtn:oe,playerWrapper:ce,player:re,noVideo:me,controls:le,controlBtn:pe,syncLabel:de,memberCount:he,episodeSection:_e,episodeGrid:ge,episodeBtn:ue,epActive:ye,chatSidebar:we,chatHeader:xe,membersList:je,memberTag:be,hostTag:ve,chatMessages:Ne,chatEmpty:fe,message:Se,myMessage:Te,msgUser:Ce,msgText:ke,msgTime:Be,chatInput:Pe},Ae=()=>{const{roomId:a}=I(),g=H(),[n,S]=c.useState(null),[d,T]=c.useState(null),[m,C]=c.useState([]),[l,u]=c.useState(""),[k,B]=c.useState(!0),[P,y]=c.useState(!1),[w,x]=c.useState(0),j=c.useRef(null),p=i.getSession();c.useEffect(()=>{i.joinRoom(a).catch(o=>{console.error("Join error:",o)});const t=i.onRoomUpdate(a,o=>{if(!o){g("/watch-party");return}S(o),o.playback?.episode!==void 0&&x(o.playback.episode),B(!1),!d&&o.movieSlug&&J.getMovieDetail(o.movieSlug).then(N=>{N?.data?.item&&T(N.data.item)}).catch(()=>{})}),r=i.onMessages(a,o=>{C(o)});return()=>{t(),r(),i.leaveRoom(a)}},[a]),c.useEffect(()=>{j.current?.scrollIntoView({behavior:"smooth"})},[m]);const M=async t=>{t.preventDefault(),l.trim()&&(await i.sendMessage(a,l.trim()),u(""))},L=async()=>{if(n?.hostId!==p.id)return;const t=n?.playback?.isPlaying;await i.syncPlayback(a,{isPlaying:!t}),await i.updateRoomStatus(a,t?"paused":"playing")},R=async t=>{n?.hostId===p.id&&(x(t),await i.syncPlayback(a,{episode:t,currentTime:0,isPlaying:!0}),await i.updateRoomStatus(a,"playing"))},E=()=>{navigator.clipboard.writeText(window.location.href),y(!0),setTimeout(()=>y(!1),2e3)},F=async()=>{await i.leaveRoom(a),g("/watch-party")},h=n?.hostId===p.id,b=n?.members?Object.values(n.members):[],_=d?.episodes?.[0]?.server_data||[],v=_[w];return k?e.jsxs("div",{className:s.loadingPage,children:[e.jsx("div",{className:s.spinner}),e.jsx("p",{children:"Äang tham gia phÃ²ng..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(D,{}),e.jsx("main",{className:s.room,children:e.jsxs("div",{className:s.layout,children:[e.jsxs("div",{className:s.mainContent,children:[e.jsxs("div",{className:s.topBar,children:[e.jsxs("button",{className:s.backBtn,onClick:F,children:[e.jsx($,{})," Rá»i phÃ²ng"]}),e.jsxs("div",{className:s.roomTitle,children:[e.jsx("span",{className:`${s.statusDot} ${s[n?.status||"waiting"]}`}),n?.movieName]}),e.jsx("button",{className:s.copyBtn,onClick:E,children:P?e.jsxs(e.Fragment,{children:[e.jsx(A,{})," ÄÃ£ copy"]}):e.jsxs(e.Fragment,{children:[e.jsx(U,{})," Chia sáº» link"]})})]}),e.jsx("div",{className:s.playerWrapper,children:v?.link_embed?e.jsx("iframe",{src:v.link_embed,className:s.player,allowFullScreen:!0,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"}):e.jsxs("div",{className:s.noVideo,children:[e.jsx(f,{size:48}),e.jsx("p",{children:d?"Äang táº£i video...":"Äang táº£i phim..."})]})}),e.jsxs("div",{className:s.controls,children:[e.jsxs("div",{className:s.controlLeft,children:[h&&e.jsxs("button",{className:s.controlBtn,onClick:L,children:[n?.playback?.isPlaying?e.jsx(V,{}):e.jsx(f,{}),n?.playback?.isPlaying?"Táº¡m dá»«ng":"PhÃ¡t"]}),!h&&e.jsxs("span",{className:s.syncLabel,children:["ðŸ”„ Äá»“ng bá»™ vá»›i ",n?.hostName]})]}),e.jsx("div",{className:s.controlRight,children:e.jsxs("span",{className:s.memberCount,children:[e.jsx(G,{})," ",b.length," ngÆ°á»i"]})})]}),_.length>1&&e.jsxs("div",{className:s.episodeSection,children:[e.jsx("h4",{children:"Táº­p phim"}),e.jsx("div",{className:s.episodeGrid,children:_.map((t,r)=>e.jsx("button",{className:`${s.episodeBtn} ${r===w?s.epActive:""}`,onClick:()=>R(r),disabled:!h,children:t.name},r))})]})]}),e.jsxs("div",{className:s.chatSidebar,children:[e.jsxs("div",{className:s.chatHeader,children:[e.jsxs("h3",{children:["Chat (",m.length,")"]}),e.jsx("div",{className:s.membersList,children:b.map((t,r)=>e.jsx("span",{className:`${s.memberTag} ${t.isHost?s.hostTag:""}`,title:t.name,children:t.name.charAt(0)},r))})]}),e.jsxs("div",{className:s.chatMessages,children:[m.length===0?e.jsx("div",{className:s.chatEmpty,children:e.jsx("p",{children:"ChÆ°a cÃ³ tin nháº¯n. HÃ£y báº¯t Ä‘áº§u trÃ² chuyá»‡n!"})}):m.map(t=>e.jsxs("div",{className:`${s.message} ${t.userId===p.id?s.myMessage:""}`,children:[e.jsx("span",{className:s.msgUser,children:t.userName}),e.jsx("p",{className:s.msgText,children:t.text}),e.jsx("span",{className:s.msgTime,children:new Date(t.timestamp).toLocaleTimeString("vi",{hour:"2-digit",minute:"2-digit"})})]},t.id)),e.jsx("div",{ref:j})]}),e.jsxs("form",{className:s.chatInput,onSubmit:M,children:[e.jsx("input",{type:"text",value:l,onChange:t=>u(t.target.value),placeholder:"Nháº­p tin nháº¯n...",maxLength:500}),e.jsx("button",{type:"submit",disabled:!l.trim(),children:e.jsx(W,{})})]})]})]})})]})};export{Ae as default};
