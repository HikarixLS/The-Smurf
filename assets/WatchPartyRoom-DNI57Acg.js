import{u as be,j as e}from"./index-Ce0K8VUX.js";import{h as Ne,e as ke,b as a}from"./vendor-DTekaQTv.js";import{H as S}from"./hls-Cp2x8l1r.js";import{A as Se,I as U,J as Te,F as z,s as Be,v as Me,w as Ce,G,z as Ee,K as Pe,L as Re}from"./index-D5LGCugf.js";import{H as we}from"./Header-aWFzr601.js";import{w as r}from"./watchPartyService-RU8y7Onb.js";import{m as Ie}from"./movieService-BaVLUEmp.js";import"./firebase-B8FQZRyY.js";import"./endpoints-xqRzFTK4.js";const Fe="_room_97yes_1",Le="_loadingPage_97yes_13",He="_spinner_97yes_35",$e="_spin_97yes_35",Ae="_layout_97yes_67",De="_mainContent_97yes_79",Oe="_topBar_97yes_95",We="_backBtn_97yes_113",Ve="_roomTitle_97yes_151",Ue="_statusDot_97yes_179",ze="_playing_97yes_193",Ge="_pulse_97yes_1",qe="_paused_97yes_203",Ke="_waiting_97yes_211",Xe="_copyBtn_97yes_243",Je="_syncIndicator_97yes_283",Ye="_bufferWarning_97yes_307",Qe="_playerWrapper_97yes_327",Ze="_player_97yes_327",es="_bufferOverlay_97yes_357",ss="_seekBar_97yes_379",ts="_seekProgress_97yes_405",ns="_iconBtn_97yes_421",as="_timeDisplay_97yes_459",is="_noVideo_97yes_473",cs="_controls_97yes_497",rs="_controlBtn_97yes_515",os="_syncLabel_97yes_553",ls="_memberCount_97yes_563",ms="_episodeSection_97yes_581",us="_episodeGrid_97yes_601",ds="_episodeBtn_97yes_613",ps="_epActive_97yes_655",_s="_chatSidebar_97yes_669",ys="_chatHeader_97yes_687",hs="_membersList_97yes_715",gs="_memberTag_97yes_725",fs="_hostTag_97yes_751",xs="_chatMessages_97yes_765",js="_chatEmpty_97yes_783",vs="_message_97yes_803",bs="_myMessage_97yes_819",Ns="_msgUser_97yes_831",ks="_msgText_97yes_843",Ss="_msgTime_97yes_859",Ts="_chatInput_97yes_871",Bs="_nicknameBar_97yes_975",Ms="_nicknameDisplay_97yes_985",Cs="_nicknameEditBtn_97yes_1009",Es="_nicknameEdit_97yes_1009",Ps="_nicknameInput_97yes_1057",Rs="_nicknameSave_97yes_1089",ws="_systemMessage_97yes_1117",s={room:Fe,loadingPage:Le,spinner:He,spin:$e,layout:Ae,mainContent:De,topBar:Oe,backBtn:We,roomTitle:Ve,statusDot:Ue,playing:ze,pulse:Ge,paused:qe,waiting:Ke,copyBtn:Xe,syncIndicator:Je,bufferWarning:Ye,playerWrapper:Qe,player:Ze,bufferOverlay:es,seekBar:ss,seekProgress:ts,iconBtn:ns,timeDisplay:as,noVideo:is,controls:cs,controlBtn:rs,syncLabel:os,memberCount:ls,episodeSection:ms,episodeGrid:us,episodeBtn:ds,epActive:ps,chatSidebar:_s,chatHeader:ys,membersList:hs,memberTag:gs,hostTag:fs,chatMessages:xs,chatEmpty:js,message:vs,myMessage:bs,msgUser:Ns,msgText:ks,msgTime:Ss,chatInput:Ts,nicknameBar:Bs,nicknameDisplay:Ms,nicknameEditBtn:Cs,nicknameEdit:Es,nicknameInput:Ps,nicknameSave:Rs,systemMessage:ws},Is=3,Fs=2500,zs=()=>{const{roomId:o}=Ne(),E=ke(),{user:y}=be(),[l,q]=a.useState(null),[g,K]=a.useState(null),[j,X]=a.useState([]),[v,P]=a.useState(""),[J,Y]=a.useState(!0),[Q,R]=a.useState(!1),[d,w]=a.useState(0),[Z,I]=a.useState(!1),[b,T]=a.useState(""),[F,L]=a.useState(!1),[ee,se]=a.useState(!1),[H,te]=a.useState(0),[N,ne]=a.useState(0),[ae,$]=a.useState(!1),c=a.useRef(null),_=a.useRef(null),A=a.useRef(null),h=a.useRef(!1),D=a.useRef(null),B=a.useRef(null),ie=a.useRef(null),u=r.getSession();a.useEffect(()=>{ie.current=l},[l]),a.useEffect(()=>{y?.displayName?(T(y.displayName),r.updateName(y.displayName)):T(u.name)},[y]),a.useEffect(()=>{const t=y?.displayName||u.name;r.updateName(t),r.joinRoom(o).catch(console.error),r.sendMessage(o,`ðŸ“¢ ${t} Ä‘Ã£ vÃ o phÃ²ng`);const n=r.onRoomUpdate(o,i=>{if(!i){E("/watch-party");return}if(B.current&&i.members){const p=new Set(Object.keys(B.current));Object.keys(i.members).forEach(x=>{!p.has(x)&&u.id})}B.current=i.members||{},q(i),i.playback?.episode!==void 0&&w(i.playback.episode),Y(!1),!g&&i.movieSlug&&Ie.getMovieDetail(i.movieSlug).then(p=>{p?.data?.item&&K(p.data.item)}).catch(()=>{}),i.hostId!==u.id&&i.playback&&c.current&&ce(i.playback)}),m=r.onMessages(o,X);return()=>{n(),m();const i=y?.displayName||u.name;r.sendMessage(o,`ðŸ‘‹ ${i} Ä‘Ã£ rá»i phÃ²ng`),r.leaveRoom(o)}},[o]),a.useEffect(()=>{const n=(g?.episodes?.[0]?.server_data||[])[d];if(!n?.link_m3u8||!c.current)return;_.current&&(_.current.destroy(),_.current=null);const m=c.current;if(S.isSupported()){const i=new S({maxBufferLength:30,maxMaxBufferLength:60});i.loadSource(n.link_m3u8),i.attachMedia(m),i.on(S.Events.MANIFEST_PARSED,()=>{}),i.on(S.Events.ERROR,(p,x)=>{x.fatal&&console.error("HLS fatal error:",x)}),_.current=i}else m.canPlayType("application/vnd.apple.mpegurl")&&(m.src=n.link_m3u8);return()=>{_.current&&(_.current.destroy(),_.current=null)}},[g,d]),a.useEffect(()=>{if(!(!l||l.hostId!==u.id))return D.current=setInterval(()=>{!c.current||h.current||r.syncPlayback(o,{currentTime:c.current.currentTime,isPlaying:!c.current.paused,episode:d})},Fs),()=>clearInterval(D.current)},[l,d,o]);const ce=a.useCallback(t=>{const n=c.current;if(!n||h.current)return;const m=re(t.currentTime||0,t.updatedAt||Date.now(),t.isPlaying),i=Math.abs(n.currentTime-m);h.current=!0,i>Is&&(n.currentTime=m),t.isPlaying&&n.paused?n.play().catch(()=>{}):!t.isPlaying&&!n.paused&&n.pause(),setTimeout(()=>{h.current=!1},500)},[]);function re(t,n,m){if(!m)return t;const i=(Date.now()-n)/1e3;return t+Math.min(i,10)}a.useEffect(()=>{A.current?.scrollIntoView({behavior:"smooth"})},[j]);const oe=()=>{c.current&&te(c.current.currentTime)},le=()=>{c.current&&ne(c.current.duration)},me=()=>L(!0),ue=()=>L(!1),de=()=>$(!0),pe=()=>$(!1),_e=a.useCallback(()=>{const t=c.current;!t||l?.hostId!==u.id||(h.current=!0,t.paused?(t.play().catch(()=>{}),r.syncPlayback(o,{currentTime:t.currentTime,isPlaying:!0,episode:d}),r.updateRoomStatus(o,"playing"),r.sendMessage(o,"â–¶ï¸ Host Ä‘Ã£ báº¥m phÃ¡t")):(t.pause(),r.syncPlayback(o,{currentTime:t.currentTime,isPlaying:!1,episode:d}),r.updateRoomStatus(o,"paused"),r.sendMessage(o,"â¸ï¸ Host Ä‘Ã£ táº¡m dá»«ng")),setTimeout(()=>{h.current=!1},500))},[l,d,o]),ye=t=>{const n=c.current;if(!n||l?.hostId!==u.id)return;const m=t.currentTarget.getBoundingClientRect(),p=(t.clientX-m.left)/m.width*N;n.currentTime=p,r.syncPlayback(o,{currentTime:p,isPlaying:!n.paused,episode:d})},he=()=>{c.current&&(c.current.muted=!c.current.muted,se(c.current.muted))},ge=()=>{c.current&&(c.current.requestFullscreen?c.current.requestFullscreen():c.current.webkitRequestFullscreen&&c.current.webkitRequestFullscreen())},fe=async t=>{t.preventDefault(),v.trim()&&(await r.sendMessage(o,v.trim()),P(""))},xe=async t=>{l?.hostId===u.id&&(w(t),await r.syncPlayback(o,{episode:t,currentTime:0,isPlaying:!1}),await r.updateRoomStatus(o,"waiting"),await r.sendMessage(o,`ðŸ“º ÄÃ£ chuyá»ƒn sang táº­p ${t+1}`))},je=()=>{navigator.clipboard.writeText(window.location.href),R(!0),setTimeout(()=>R(!1),2e3)},ve=()=>E("/watch-party"),O=()=>{b.trim()&&(r.updateName(b.trim()),I(!1),l&&r.joinRoom(o))},W=t=>{if(!t||isNaN(t))return"0:00";const n=Math.floor(t/60),m=Math.floor(t%60);return`${n}:${m.toString().padStart(2,"0")}`},V=l?.hostId===u.id,M=l?.members?Object.values(l.members):[],C=g?.episodes?.[0]?.server_data||[],k=C[d],f=!!k?.link_m3u8;return J?e.jsxs("div",{className:s.loadingPage,children:[e.jsx("div",{className:s.spinner}),e.jsx("p",{children:"Äang tham gia phÃ²ng..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{}),e.jsx("main",{className:s.room,children:e.jsxs("div",{className:s.layout,children:[e.jsxs("div",{className:s.mainContent,children:[e.jsxs("div",{className:s.topBar,children:[e.jsxs("button",{className:s.backBtn,onClick:ve,children:[e.jsx(Se,{})," Rá»i phÃ²ng"]}),e.jsxs("div",{className:s.roomTitle,children:[e.jsx("span",{className:`${s.statusDot} ${s[l?.status||"waiting"]}`}),l?.movieOriginName||l?.movieName]}),e.jsx("button",{className:s.copyBtn,onClick:je,children:Q?e.jsxs(e.Fragment,{children:[e.jsx(U,{})," ÄÃ£ copy"]}):e.jsxs(e.Fragment,{children:[e.jsx(Te,{})," Chia sáº»"]})})]}),e.jsxs("div",{className:s.playerWrapper,children:[f?e.jsx("video",{ref:c,className:s.player,onTimeUpdate:oe,onDurationChange:le,onPlay:me,onPause:ue,onWaiting:de,onCanPlay:pe,playsInline:!0}):k?.link_embed?e.jsx("iframe",{src:k.link_embed,className:s.player,allowFullScreen:!0,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"}):e.jsxs("div",{className:s.noVideo,children:[e.jsx(z,{size:48}),e.jsx("p",{children:g?"Äang táº£i video...":"Äang táº£i phim..."})]}),ae&&f&&e.jsx("div",{className:s.bufferOverlay,children:e.jsx("div",{className:s.spinner})})]}),f&&e.jsxs("div",{className:s.controls,children:[e.jsxs("div",{className:s.controlLeft,children:[V?e.jsxs("button",{className:s.controlBtn,onClick:_e,children:[F?e.jsx(Be,{}):e.jsx(z,{}),F?" Táº¡m dá»«ng":" PhÃ¡t"]}):e.jsxs("span",{className:s.syncLabel,children:["ðŸ”„ Äá»“ng bá»™ vá»›i ",l?.hostName]}),e.jsx("button",{className:s.iconBtn,onClick:he,children:ee?e.jsx(Me,{}):e.jsx(Ce,{})}),e.jsxs("span",{className:s.timeDisplay,children:[W(H)," / ",W(N)]})]}),e.jsxs("div",{className:s.controlRight,children:[e.jsxs("span",{className:s.memberCount,children:[e.jsx(G,{})," ",M.length]}),e.jsx("button",{className:s.iconBtn,onClick:ge,children:e.jsx(Ee,{})})]})]}),f&&e.jsx("div",{className:s.seekBar,onClick:ye,children:e.jsx("div",{className:s.seekProgress,style:{width:`${N?H/N*100:0}%`}})}),!f&&k?.link_embed&&e.jsxs("div",{className:s.controls,children:[e.jsx("div",{className:s.controlLeft,children:e.jsx("span",{className:s.syncLabel,children:"ðŸ“º DÃ¹ng Ä‘iá»u khiá»ƒn trong player"})}),e.jsx("div",{className:s.controlRight,children:e.jsxs("span",{className:s.memberCount,children:[e.jsx(G,{})," ",M.length]})})]}),C.length>1&&e.jsxs("div",{className:s.episodeSection,children:[e.jsx("h4",{children:"Táº­p phim"}),e.jsx("div",{className:s.episodeGrid,children:C.map((t,n)=>e.jsx("button",{className:`${s.episodeBtn} ${n===d?s.epActive:""}`,onClick:()=>xe(n),disabled:!V,children:t.name},n))})]})]}),e.jsxs("div",{className:s.chatSidebar,children:[e.jsxs("div",{className:s.chatHeader,children:[e.jsxs("h3",{children:["Chat (",j.length,")"]}),e.jsx("div",{className:s.membersList,children:M.map((t,n)=>e.jsx("span",{className:`${s.memberTag} ${t.isHost?s.hostTag:""}`,title:t.name,children:t.name.charAt(0)},n))})]}),e.jsx("div",{className:s.nicknameBar,children:Z?e.jsxs("div",{className:s.nicknameEdit,children:[e.jsx("input",{type:"text",value:b,onChange:t=>T(t.target.value),onKeyDown:t=>t.key==="Enter"&&O(),maxLength:20,autoFocus:!0,className:s.nicknameInput}),e.jsx("button",{onClick:O,className:s.nicknameSave,children:e.jsx(U,{size:14})})]}):e.jsxs("div",{className:s.nicknameDisplay,children:[e.jsxs("span",{children:["Báº¡n: ",e.jsx("strong",{children:b})]}),e.jsxs("button",{onClick:()=>I(!0),className:s.nicknameEditBtn,children:[e.jsx(Pe,{size:12})," Äá»•i tÃªn"]})]})}),e.jsxs("div",{className:s.chatMessages,children:[j.length===0?e.jsx("div",{className:s.chatEmpty,children:e.jsx("p",{children:"ChÆ°a cÃ³ tin nháº¯n. HÃ£y báº¯t Ä‘áº§u trÃ² chuyá»‡n!"})}):j.map(t=>{const n=/^(ðŸ“¢|ðŸ‘‹|â–¶ï¸|â¸ï¸|ðŸ“º|â³)/.test(t.text);return e.jsxs("div",{className:`${s.message} ${t.userId===u.id?s.myMessage:""} ${n?s.systemMessage:""}`,children:[!n&&e.jsx("span",{className:s.msgUser,children:t.userName}),e.jsx("p",{className:s.msgText,children:t.text}),e.jsx("span",{className:s.msgTime,children:new Date(t.timestamp).toLocaleTimeString("vi",{hour:"2-digit",minute:"2-digit"})})]},t.id)}),e.jsx("div",{ref:A})]}),e.jsxs("form",{className:s.chatInput,onSubmit:fe,children:[e.jsx("input",{type:"text",value:v,onChange:t=>P(t.target.value),placeholder:"Nháº­p tin nháº¯n...",maxLength:500}),e.jsx("button",{type:"submit",disabled:!v.trim(),children:e.jsx(Re,{})})]})]})]})})]})};export{zs as default};
